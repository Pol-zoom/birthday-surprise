<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>С Днём Рождения, Алёна!</title>
<style>
  :root{
    --bg:#0a0210;
    --neon:#ff00ff;
    --neon-2:#8a2be2;
    --neon-pink:#ff69b4;
  }
  *{box-sizing:border-box;}
  body{
    margin:0;
    min-height:100vh;
    background:var(--bg);
    font-family:"Courier New", monospace;
    color:var(--neon);
    overflow:hidden;
    display:flex;
    justify-content:center;
    align-items:center;
    cursor:pointer;
  }
  canvas{ position:fixed; top:0; left:0; width:100%; height:100%; z-index:0; display:block; }

  .screen{
    position:relative;
    z-index:3;
    width:84%;
    max-width:820px;
    min-width:320px;
    padding:24px;
    background:rgba(18,4,30,0.82);
    border-radius:14px;
    border:2px solid var(--neon);
    box-shadow:0 0 22px var(--neon),0 0 44px var(--neon-2);
    text-align:left;
  }

  #hackText{ min-height:56px; font-size:18px; color:var(--neon); }

  .typing-cursor::after{
    content:"";
    display:inline-block;
    width:2px;
    height:1.05em;
    background:var(--neon);
    margin-left:6px;
    animation:blink 0.8s steps(1) infinite;
    vertical-align:bottom;
  }
  @keyframes blink{ 0%,50%,100%{opacity:1} 25%,75%{opacity:0} }

  .card{
    margin-top:18px;
    padding:14px;
    background:rgba(0,0,0,0.45);
    border-radius:10px;
    border:1px solid rgba(255,0,255,0.12);
    box-shadow:0 0 10px rgba(255,0,255,0.06);
    display:none;
    text-align:left;
    z-index:11;
  }

  .card p{
    margin:8px 0;
    color:var(--neon);
    font-size:16px;
    line-height:1.25;
    opacity:0;
  }

  #startMessage{
    position:absolute;
    z-index:4;
    top:50%; left:50%;
    transform:translate(-50%,-50%);
    text-align:center;
    color:var(--neon);
    font-size:20px;
    padding:10px 16px;
    border-radius:8px;
    text-shadow:0 0 10px var(--neon);
    pointer-events:none;
  }

  #musicPrompt{
    position:absolute;
    z-index:10;
    top:50%; left:50%;
    transform:translate(-50%,-50%);
    background:rgba(0,0,0,0.95);
    color:var(--neon);
    padding:20px 28px;
    border-radius:12px;
    text-align:center;
    display:none;
    box-shadow:0 0 30px var(--neon);
  }
  #musicPrompt button{
    margin:10px 6px 0;
    padding:8px 14px;
    font-size:16px;
    cursor:pointer;
    border:none;
    border-radius:8px;
    background:var(--neon);
    color:#000;
  }

  @keyframes flash {
    0% { opacity:0; text-shadow:0 0 22px var(--neon),0 0 44px var(--neon-pink); }
    35% { opacity:1; text-shadow:0 0 40px var(--neon),0 0 60px var(--neon-pink); }
    100% { opacity:1; text-shadow:0 0 6px var(--neon),0 0 12px var(--neon-2); }
  }

  @media (max-width:900px){
    .screen{ width:95%; }
  }
</style>
</head>
<body>

<canvas id="matrixCanvas"></canvas>
<canvas id="particleCanvas" style="z-index:2; position:fixed; top:0; left:0;"></canvas>

<div class="screen" id="screen">
  <div id="hackText" aria-live="polite"></div>
  <div class="card" id="card" aria-hidden="true"></div>
</div>

<div id="startMessage">Нажмите Enter или тапните по экрану, чтобы начать</div>

<div id="musicPrompt" role="dialog" aria-modal="true">
  Хотите прослушать музыку к открытке?<br>
  <button id="musicYes">Да</button>
  <button id="musicNo">Нет</button>
</div>

<!-- используем OGG для надёжности -->
<audio id="bgMusic" src="Samoy_krasivoy_devushke.ogg" loop></audio>

<script>
// ====== Элементы и состояние ======
const matrixCanvas = document.getElementById('matrixCanvas');
const matrixCtx = matrixCanvas.getContext('2d');
const particleCanvas = document.getElementById('particleCanvas');
const pctx = particleCanvas.getContext('2d');

const hackTextElem = document.getElementById('hackText');
const card = document.getElementById('card');
const startMessage = document.getElementById('startMessage');
const musicPrompt = document.getElementById('musicPrompt');
const musicYes = document.getElementById('musicYes');
const musicNo = document.getElementById('musicNo');
const bgMusic = document.getElementById('bgMusic');

let W = matrixCanvas.width = particleCanvas.width = window.innerWidth;
let H = matrixCanvas.height = particleCanvas.height = window.innerHeight;
let fontSize = Math.max(14, Math.floor(Math.min(W,H)/48));
let columns = Math.floor(W/fontSize);
let drops = new Array(columns).fill(0);
const chars = '0123456789abcdef<>/{}[]()@#$%^&*-_=+;:,.;:';

let matrixTick = null;
let running = false;
let musicPromptShown = false; // флаг — окно музыки показывать только один раз

window.addEventListener('resize', ()=>{
  W = matrixCanvas.width = particleCanvas.width = window.innerWidth;
  H = matrixCanvas.height = particleCanvas.height = window.innerHeight;
  fontSize = Math.max(14, Math.floor(Math.min(W,H)/48));
  columns = Math.floor(W/fontSize);
  drops = new Array(columns).fill(0);
});

// ====== Матрица ======
function drawMatrix(){
  matrixCtx.fillStyle = 'rgba(2,0,6,0.06)';
  matrixCtx.fillRect(0,0,W,H);
  matrixCtx.font = `${fontSize}px monospace`;
  for(let i=0;i<columns;i++){
    const rand = Math.random();
    matrixCtx.fillStyle = rand<0.82?'#ff00ff':rand<0.93?'#ff69b4':'#8a2be2';
    const ch = chars[Math.floor(Math.random()*chars.length)];
    matrixCtx.fillText(ch,i*fontSize,drops[i]*fontSize);
    if(drops[i]*fontSize>H && Math.random()>0.975) drops[i]=0;
    drops[i]++;
  }
}

// ====== Частицы ======
const particles=[];
function spawnExplosion(x,y,colorMain='#ff00ff',count=28){
  for(let i=0;i<count;i++){
    const angle = Math.random()*Math.PI*2;
    const speed = (Math.random()*2.6+1.2)*(1+window.devicePixelRatio*0.2);
    particles.push({
      x,y,
      vx: Math.cos(angle)*speed,
      vy: Math.sin(angle)*speed,
      life: Math.random()*500+400,
      born: performance.now(),
      size: Math.random()*6+4,
      color: (Math.random()>0.85?'#ff69b4':Math.random()>0.95?'#8a2be2':colorMain),
      char: chars[Math.floor(Math.random()*chars.length)],
      alpha:1
    });
  }
}
function updateParticles(now){
  pctx.clearRect(0,0,W,H);
  for(let i=particles.length-1;i>=0;i--){
    const p=particles[i];
    const age = now-p.born;
    if(age>=p.life){particles.splice(i,1); continue;}
    const t=age/p.life;
    p.x+=p.vx*(1+0.02*(Math.random()-0.5));
    p.y+=p.vy*(1+0.02*(Math.random()-0.5));
    p.alpha = 1-t;
    pctx.globalAlpha=p.alpha;
    pctx.fillStyle=p.color;
    pctx.font=`${Math.max(10,Math.floor(p.size))}px monospace`;
    pctx.fillText(p.char,p.x,p.y);
    pctx.globalAlpha=1;
  }
}

// ====== Тексты (обновлённые hackSteps) ======
const hackSteps = [
  "Ищем поздравление...",
  "Поздравление не найдено",
  "Идём на крайние меры",
  "Взлом Пентагона...",
  "Из Пентагона для тебя поздравлений нет..",
  "Но есть поздравление от меня)",
  "Тогда надо глянуть где оно лежит...",
  "Ищём..... Ищём....",
  "О! Я нашёл! Вот оно!"
];

const wishes = [
  "С Днём Рождения, Алёна!",
  "Пусть каждый день будет ярким, как этот неон!",
  "Желаю счастья, радости и вдохновения!",
  "Пусть все мечты сбываются!",
  "Мирного неба над головой".
  "Ты самая лучшая!"
];

// ====== Печатание текста ======
function typeTextToElement(el,text,speed=60){
  return new Promise(resolve=>{
    el.classList.add('typing-cursor');
    el.textContent='';
    let i=0;
    const iv=setInterval(()=>{
      if(i>=text.length){clearInterval(iv); setTimeout(()=>{el.classList.remove('typing-cursor'); resolve();},300); return;}
      el.textContent+=text[i++];
    },speed);
  });
}

function getElementCenterRect(el){
  const r=el.getBoundingClientRect();
  return {x:r.left+r.width/2,y:r.top+r.height/2};
}

async function runHackSequence(){
  for(let i=0;i<hackSteps.length;i++){
    hackTextElem.textContent='';
    await typeTextToElement(hackTextElem,hackSteps[i],70);
    await new Promise(r=>setTimeout(r,550));
  }
  hackTextElem.style.transition='opacity 300ms';
  hackTextElem.style.opacity='0';
  await new Promise(r=>setTimeout(r,320));
  card.style.display='block';
  card.setAttribute('aria-hidden','false');
  await runCardWithExplosions();
}

async function runCardWithExplosions(){
  for(let i=0;i<wishes.length;i++){
    const p=document.createElement('p');
    card.appendChild(p);
    await typeTextToElement(p,wishes[i],i===0?100:60);
    p.style.animation='none';
    void p.offsetWidth;
    p.style.animation='flash 0.42s forwards';
    const pos=getElementCenterRect(p);
    spawnExplosion(pos.x,pos.y-6,'#ff00ff',36);
    await new Promise(r=>setTimeout(r,420));
  }
}

// ====== Плавное включение музыки ======
function fadeInAudio(audio, targetVolume=0.2, duration=2000){
  audio.volume = 0;
  audio.play().catch(()=>{});
  const stepTime = 50;
  const stepVolume = targetVolume / (duration / stepTime);
  const fadeInterval = setInterval(()=>{
    if(audio.volume + stepVolume >= targetVolume){
      audio.volume = targetVolume;
      clearInterval(fadeInterval);
    } else {
      audio.volume += stepVolume;
    }
  }, stepTime);
}

// ====== Анимация ======
function animate(now){
  updateParticles(now);
  if(running) requestAnimationFrame(animate);
}

// ====== Старт ======
function startAll(){
  if(running) return;
  running = true;
  startMessage.style.display = 'none';
  if(matrixTick) clearInterval(matrixTick);
  matrixTick = setInterval(drawMatrix,35);
  requestAnimationFrame(animate);
  runHackSequence();
}

// ====== Окно музыки (только один раз) ======
function showMusicPrompt(){
  if(musicPromptShown) return;
  musicPromptShown = true;
  startMessage.style.display = 'none';
  musicPrompt.style.display = 'block';
  musicYes.focus();
}

// Обработчики, которые вызывают showMusicPrompt — но showMusicPrompt с флагом защитит от повторного показа
function onKey(e){ if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); showMusicPrompt(); } }
function onTouch(){ showMusicPrompt(); }
function onClickStart(){ showMusicPrompt(); }

window.addEventListener('keydown', onKey, {passive:false});
window.addEventListener('touchstart', onTouch, {passive:true});
window.addEventListener('click', onClickStart);

// ====== Кнопки музыки ======
musicYes.addEventListener('click', ()=>{
  // прячем и блокируем окно навсегда
  musicPrompt.style.display = 'none';
  musicPrompt.style.pointerEvents = 'none';
  fadeInAudio(bgMusic, 0.2, 2000);
  startAll();
});

musicNo.addEventListener('click', ()=>{
  musicPrompt.style.display = 'none';
  musicPrompt.style.pointerEvents = 'none';
  startAll();
});

// Если аудио не загрузилось — сообщим в консоль
bgMusic.addEventListener('error', ()=>console.warn('Ошибка загрузки аудио — проверьте Samoy_krasivoy_devushke.ogg'));

// Esc закроет окно музыки и запустит открытку (удобно)
window.addEventListener('keydown', (e)=>{
  if(e.key === 'Escape' && musicPrompt.style.display === 'block'){
    musicPrompt.style.display = 'none';
    musicPrompt.style.pointerEvents = 'none';
    startAll();
  }
});

// показываем подсказку
startMessage.style.display = 'block';

// добавляем keyframes для flash (чтобы работало в рантайме)
(function addFlashKeyframes(){
  const style=document.createElement('style');
  style.innerHTML=`@keyframes flash {
    0% { opacity:0; text-shadow:0 0 22px var(--neon),0 0 44px var(--neon-pink);}
    35% { opacity:1; text-shadow:0 0 40px var(--neon),0 0 60px var(--neon-pink);}
    100% { opacity:1; text-shadow:0 0 6px var(--neon),0 0 12px var(--neon-2);}
  }`;
  document.head.appendChild(style);
})();
</script>
</body>
</html>
